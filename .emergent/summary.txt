<analysis>**original_problem_statement:**
The user initially requested UI/UX enhancements and deeper integration between the Customer and Business management features. However, the focus of this session shifted entirely to a new, comprehensive Invoice Management feature.

**PRODUCT REQUIREMENTS:**
1.  **Invoice Creation:**
    *   Create a new page for generating invoices.
    *   Customer selection dropdown should be searchable and display .
    *   Automatically determine GST type (CGST/SGST for intra-state, IGST for inter-state) by comparing the customer's state with the admin's business state (from Settings).
    *   Invoice items should have a rate toggle: With GST (inclusive, default) and Without GST (exclusive).
    *   Provide standard GST rates (5%, 12%, 18%, 28%) with an option for manual entry.
    *   Implement an item-by-item confirmation flow: An item is added in an editable card, and a Confirm Item button finalizes it into a read-only summary row. Multiple items can be added this way.
    *   Confirmed items in the summary row should have Edit and Delete icons.

2.  **Payment Tracking:**
    *   Add a detailed payment section to the invoice form.
    *   Implement payment statuses: , , .
    *   If Partial is selected, an input field for the paid amount should appear, and the Balance Due should be calculated and displayed prominently.
    -   Payment methods should include , , , , , and .
    -   Include a field for .

3.  **Invoice Listing & Management:**
    *   Create an All Invoices page with a data table.
    *   Implement client-side sorting for all columns.
    *   Allow searching by invoice number or customer name, and filtering by a date range.
    *   The table should display: , , , , , and action buttons ().
    *   In the status column, for Partial payments, show an info icon () that reveals the due amount on hover.
    *   Implement a soft-delete mechanism. Deleted invoices should move to a new Archives section.
    *   Create an Archives page, accessible from the sidebar, to list deleted bills and provide a Restore option.
    *   The Edit Invoice functionality should allow modification of all fields, including the date (up to the last bill date).
    *   The PDF download action should generate a document that visually matches the detailed invoice view page.

**User's preferred language**: English

**what currently exists?**
The application now includes a fully-featured Invoice Management module. This includes a sophisticated  page for generating invoices with line-item confirmation, automatic tax calculation, and detailed payment tracking. A new  page displays all invoices with client-side sorting, searching, date filtering, and actions (View, Edit, PDF Download, Soft Delete). A corresponding  page allows for viewing and restoring deleted invoices. The FastAPI backend in  has been significantly updated with new Pydantic models and API endpoints to support all CRUD operations for invoices, including the soft-delete and restore logic.

**Last working item**:
- Last item agent was working: Fixing a critical bug where updating an existing invoice by adding a new item and clicking Save Invoice resulted in a failed to update invoice error.
- Status: **USER VERIFICATION PENDING**
- Agent Testing Done: Y
- Which testing method agent to use? The agent has successfully tested the fix using the screenshot tool, verifying the entire workflow from adding an item to an existing invoice, saving it, and viewing the updated invoice. The user should now test and confirm the resolution.
- User Testing Done: N

**All Pending/In progress Issue list**:
-   **Issue 1: (P1) Verify and Test Businesses Page Enhancements**
    -   Description: This was the highest priority task from the previous session but was deferred to build the invoice feature. The  page has significant unverified UI/UX changes, including client-side sorting, dynamic dropdowns for State/City, and logic to auto-populate the state from the GSTIN. These features need to be thoroughly tested.
    -   Status: **NOT STARTED**
    -   Is recurring issue?: N
    -   Should Test frontend/backend/both after fix?: Frontend.

**In progress Task List**:
- None.

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
  - (P1) Add an Import tab/functionality for customers and businesses.
  - (P2) Add sales reports and analytics.
- **Future Tasks:**
  - Implement offline sync capabilities.
  - Develop user role management and permissions.
  - Integrate with the separate inventory management application.

**Completed work in this session**
-   **Invoice Feature Implementation (Complete Lifecycle):**
    -   **Creation ():** A new, dynamic page was built from scratch to handle invoice creation and editing. It includes customer search, automatic GST type detection, an item-by-item confirmation workflow, complex state management for calculations, and a detailed payment section with partial payment logic.
    -   **Listing ():** A new page was created to list all invoices with client-side searching, sorting, date-range filtering, and action buttons. It features a custom tooltip to show the due amount for partially paid invoices.
    -   **Archiving ():** A new page was created to display soft-deleted invoices with an option to restore them.
    -   **PDF Generation:** The PDF download functionality was updated to generate a PDF that precisely matches the invoice's detailed view format.
-   **Backend Development ():**
    -   New Pydantic models (, , ) were added.
    -   New API endpoints for the entire invoice lifecycle were implemented: create, list (with filters), update, soft-delete, and restore.
-   **UI/Navigation:**
    -   The main sidebar () was updated to include a link to the new Archives page.
    -   Frontend routing () was updated to handle all new invoice-related pages.
-   **Bug Fixes:**
    -   Resolved an issue where changing the GST rate did not trigger a recalculation of taxes.
    -   Fixed a critical crash on the Edit Invoice page by ensuring customer and invoice data were loaded in the correct order.
    -   Corrected a  error for the unit price when viewing an item in an edited invoice.
    -   Fixed a backend validation  that prevented existing invoices from being updated.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1:  Warning Suppression**
    -   Debug checklist: In , a ResizeObserver loop warning was suppressed with a global error handler as a workaround. This does not fix the underlying performance issue in the Radix UI Select component when handling large lists. The proper solution is to investigate list virtualization if the component feels slow.
    -   Why to solve this issue and what will be achieved with this?: To fix the root cause of a performance-related warning and follow best practices.
    -   Should Test frontend/backend/both after fix: Frontend.
    -   Is recurring issue?: Y

**Known issue recurrence from previous fork**
-   None.

**Code Architecture**


**Key Technical Concepts**
-   **Frontend:** React, React Hooks (, ), , Shadcn UI components, .
-   **Backend:** FastAPI, Pydantic for data modeling.
-   **Database:** MongoDB.
-   **Core Patterns:** Soft-delete implementation, complex form state management, conditional UI rendering, client-side PDF generation from HTML, client-side data table operations (search, sort, filter).

**key DB schema**
-   **invoices**:
    -   uid=0(root) gid=0(root) groups=0(root), , , , , ,  (unpaid/partial/fully_paid), , , , , 
    -   : 
    -   : 
-   **customers**: (Existing)
-   **businesses**: (Existing)

**changes in tech stack**
-   None.

**All files of reference**
-   **Created:**
    -   : The main page for viewing and managing all invoices.
    -   : Page to view and restore soft-deleted invoices.
-   **Updated:**
    -   : Overhauled to become the central component for creating and editing invoices.
    -   : Heavily modified with new models and endpoints for the invoice module.
    -   : Added navigation for the Archives page.
    -   : Added routes for all new invoice-related pages.
    -   : Its structure was used as a template for the PDF download.

**Areas that need refactoring**:
-   The  file is now extremely large and handles a vast amount of logic and state. It should be broken down into smaller, more manageable sub-components (e.g., , , , ).
-   The  error suppression in  remains a temporary workaround.

**key api endpoints**
-   : Lists invoices with support for search, sorting, and date range filtering.
-   : Creates a new invoice.
-   : Retrieves a single invoice for viewing or editing.
-   : Updates an existing invoice.
-   : Soft-deletes an invoice by setting .
-   : Restores a soft-deleted invoice.
-   : Fetches admin details for GST calculations.

**Critical Info for New Agent**
-   The user prioritized the new Invoice feature over the pending testing for the Businesses page. The next logical step is to get user verification on the latest bug fix and then address the deferred testing of the  page.
-   The  component is the heart of the new feature set but is also a technical debt risk due to its size and complexity. Be cautious when making changes there.
-   The invoice workflow involves multiple states (editing item, confirmed item, partial payment) that are handled with conditional rendering. Understanding this flow is key to debugging or enhancing the page.

**documents created in this job**
-   None.

**Last 10 User Messages and any pending user messages**
1.  **Request:** Implement a Confirm button and a summary row for added invoice items. (Completed)
2.  **Request:** Refine the item confirmation flow to be per-item, with confirmed items showing as rows with edit/delete icons. (Completed)
3.  **Request:** Add detailed payment options (status, methods, partial payment logic). (Completed)
4.  **Request:** Add Cash as the first payment method option. (Completed)
5.  **Request:** Implement invoice list sorting, date search, new columns, PDF download, editing, and a soft-delete/archive system. (Completed)
6.  **Request:** Ensure the downloaded PDF's format matches the invoice view page. (Completed)
7.  **Request:** Add a tooltip on the Partial status in the invoice list to show the due amount. (Completed)
8.  **Bug Report:** An error occurs when clicking the Edit button on an invoice. (Completed)
9.  **Bug Report:** An error failed to update invoice occurs when saving an edited invoice with a new item. (Completed, pending user verification)
10. **(No pending messages)** The last user interaction was a bug report that has now been resolved by the agent.

**Project Health Check:**
-   **Broken:** None. The last reported bug has been fixed.
-   **Mocked:** None.
-   **Unverified:** The  page contains major feature enhancements from a previous session that have not been tested.

**3rd Party Integrations**:
-   None added in this session.

**Testing status**
-   Testing agent used after significant changes: NO
-   Troubleshoot agent used after agent stuck in loop: NO
-   Test files created: None.
-   Known regressions: None.

**Credentials to test flow:**
-   None required.

**What agent forgot to execute**
-   The agent did not forget but correctly **deferred** the pending task of testing the  page enhancements to prioritize the user's new, extensive feature request for Invoice Management.</analysis>
